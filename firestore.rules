rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // Fantasy Quizzes Kingdom Game Rules
    // ==========================================

    // クイズ問題管理 (Global Questions)
    match /questions/{questionId} {
      allow read: if true; // 誰でも読み取り可能（ゲーム開始に必須）
      allow write: if request.auth != null; // 編集は認証ユーザーのみ（本来は管理者のみにすべきだが開発中は認証済みで許可）
    }

    // ランキング (Global Leaderboard)
    match /leaderboard/{scoreId} {
      allow read: if true;
      allow create: if request.auth != null || true; // 匿名ユーザーも含めてスコア登録許可 (trueで全開にする場合は注意だが、匿名認証推奨のため auth != null が良い)
    }

    // ゲームルーム (Rooms)
    match /rooms/{roomId} {
      allow read: if true; // ルーム情報の読み取りは誰でもOK
      allow create: if request.auth != null; // ルーム作成は認証必須
      allow update: if request.auth != null; // 状態更新など

      // ルーム内のプレイヤー (Players Subcollection)
      match /players/{userId} {
        allow read: if true;
        allow write: if request.auth != null; // 参加登録、スコア更新など
      }

      // ルーム内の問題 (Questions Subcollection)
      match /questions/{questionId} {
        allow read: if true;
        allow write: if request.auth != null; // ホストによる問題追加
      }
    }

    // ==========================================
    // Portal / Blog Feature Rules
    // ==========================================
    
    // 記事の統計データ（投票・コメント数）
    match /posts_stats/{slug} {
      allow read: if true; // 誰でも見れる
      allow write: if true; // 投票やカウント更新
      
      // コメントのサブコレクション
      match /comments/{commentId} {
        allow read: if true; // 誰でも見れる
        
        // 作成: ログインしており、かつ自分のIDで書き込む場合のみ許可
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        
        // 削除: ログインしており、かつ自分のIDのコメントのみ許可
        allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }
  }
}
